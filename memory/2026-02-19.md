# 2026-02-19 (Late Night Session)

## BacktestEngine 100% WR Bug — FOUND AND FIXED ✅
- **Root cause**: Strategies return `'BUY'`/`'SELL'` but engine compared against `'LONG'`/`'SHORT'`. Never matched, so:
  - Short PnL never inverted → losses showed as wins
  - Stop loss/take profit set backwards for shorts → SL triggered immediately at wrong price
  - Every trade showed +5% gain → 100% WR, Sharpe 500 trillion
- **Fix**: Normalize `BUY→LONG`, `SELL→SHORT` immediately on position open. Branch SL/TP checks by side.
- **Validation**: 8 trades, 4 wins + 4 losses = 50% WR (was 100%)
- All strategies promoted with fake 97.9 EEP need re-evaluation

## Backtest Performance Fix ✅
- Full backtest was loading ALL 36M raw ticks per strategy (2-3 min each)
- **Fix**: `limit_rows=500000` for Tier 0 full backtests (≈50K 5m candles)
- Also fixed `ORDER BY` — was ASC LIMIT (oldest rows), now DESC LIMIT wrapped in ASC subquery (most recent rows)
- Should cut pipeline from 30+ min to under 5 min

## Registry Orphan Fix ✅
- strategy_023-027 had old names in registry but classes were renamed by interface fix builder
- Deleted 5 orphan entries. Strategies already registered under correct class names.

## Pipeline Manual Run Results (Post-Interface-Fix, Pre-WR-Fix)
- 205 seconds, 5 T0→T1 promotions, 5 T1→T2 promotions
- ALL showed 100% WR — confirmed the backtest bug, not strategy bug
- Strategies that generated trades: momentum_v1 (82), momentum_v2 (207), orderflow_imbalance (1798), volume_spike (1312), volatility_regime_switch (1005), volatility_adaptive_mean_reversion (279)
- Still 0 trades: cross_asset_correlation, ema_crossover, rsi_divergence_v1

## Token Usage Tracker — DEPLOYED ✅
- `brain/scripts/token_usage_aggregator.py` reads JSONL session files
- `token-usage-tracker.timer` (systemd) runs every 15 min, zero AI tokens
- Writes to `brain/status/token_usage.md` — 5h and 24h rolling windows by model
- Fixed ISO timestamp parsing (timestamps are strings not epoch ms)
- Added to HEARTBEAT.md for every-heartbeat reporting
- 5h snapshot at 23:30: 36.7M tokens, 556 requests, $27 equivalent
- 24h snapshot: 206M tokens, 2333 requests, $135 equivalent

## Token Usage API Investigation — DEAD END
- OAuth token (`sk-ant-oat01-*`) lacks `user:profile` scope → can't call `/api/oauth/usage`
- claude.ai behind Cloudflare → can't curl or headless browser
- OpenClaw has `fetchClaudeWebUsage()` that uses session cookie but we can't get past CF
- Anthropic doesn't publish Max 5x rate limit denominator → can't calculate utilization %
- **Resolution**: JSONL aggregation is good enough. Track raw totals, no % available.

## Subagent Reliability Pattern
- First spawn attempts (21:30 MST) died at 0 tokens after 1.5h
- Re-spawned at 22:48 MST — blofin-interface-fix completed in 8 min, numerai stayed at 0 initially  
- backtest-engine-fix spawned at 23:45, completed in 3 min
- Pattern: subagents queue during heavy Opus usage periods. Rate limit recovery needed before they start.

## Power Outage Recovery
- Power flickered multiple times ~22:30 MST
- Machine rebooted, all systemd services auto-recovered
- CPU spiked to 87°C post-boot, settled to 65-75°C
- Disk grew to 35% (152GB)
