# 2026-02-16 - Daily Log

## Blofin Dashboard Server - Built & Deployed

### What We Built
Created a complete ML trading pipeline dashboard server from scratch:
- **Location:** `/home/rob/.openclaw/workspace/blofin-dashboard/`
- **URL:** http://localhost:8888/blofin-dashboard.html
- **Stack:** Python Flask + Flask-CORS, SQLite backend
- **Systemd:** Auto-starts on boot, auto-restarts on crash

### Database Schema Learnings
Through iterative debugging, mapped the actual Blofin database schema:

**Key Tables:**
- `service_heartbeats`: columns are `service`, `ts_ms`, `ts_iso`, `details_json` (NOT service_name, last_heartbeat_utc)
- `paper_trades`: timestamp column is `opened_ts_iso` (NOT created_at)
- `strategy_scores`: columns include `ts_iso`, `strategy`, `score`, `win_rate`, `sharpe_ratio`
- `strategy_backtest_results`: has `total_trades` (NOT num_trades)
- `ml_model_results`: uses `test_accuracy`, `precision_score`, `recall_score` (NOT accuracy, precision_val, recall)

### Issues Fixed
1. **Empty Strategies Display** - Dashboard only showed `active_strategies` which was empty. Fixed by falling back to `top_strategies` data.
2. **Models Showing Zero** - All 35 models were in training phase with no accuracy data. Added smart UI to show "Models in Training" status.
3. **SQL Column Mismatches** - Spent ~20 minutes debugging and correcting all column names through trial/error.
4. **Flask Decorator Conflict** - Fixed "View function mapping is overwriting" error by adding `@wraps` to the `safe_query` decorator.

### Technical Notes
- Use `PRAGMA table_info(table_name)` in sqlite3 to quickly discover schema
- Flask's `@app.route` decorator + custom decorators require `functools.wraps` to preserve function names
- Systemd user services need `systemctl --user enable` AND `systemctl --user start`
- Browser caching can hide dashboard updates - always test with hard refresh (Ctrl+Shift+R)

### Current State
- **Service:** Running and enabled via systemd
- **Health:** All 4 API endpoints returning 200
- **Data Flow:** Live pipeline showing 12k+ trades/hour, 50k+ scores/hour
- **Top Strategy:** vwap_reversion with 77.02 best score
- **Models:** 35 models in training phase (no test results yet)

### Files Created
- `server.py` (9.1KB) - Flask API server
- `blofin-dashboard.html` (16KB) - Frontend with auto-refresh
- `README.md` (3.6KB) - Complete documentation

### Command Reference
```bash
# Service management
systemctl --user status blofin-dashboard.service
systemctl --user restart blofin-dashboard.service
journalctl --user -u blofin-dashboard.service -f

# Quick health check
curl http://localhost:8888/health | python3 -m json.tool
```

### Lessons Learned
1. **Always check schema first** - Would have saved 15 minutes if I'd run `PRAGMA table_info` on all tables immediately
2. **Test API endpoints before frontend** - Caught all backend issues before touching HTML
3. **Graceful degradation matters** - Showing "Models in Training" vs empty/error is much better UX
4. **Document as you go** - Created comprehensive README immediately while details were fresh

---

## Dashboard v2.0 - Professional Redesign (08:51-09:00 MST)

### User Request
"make it fancy, make it a react dashboard or something. use dark modern colors, shadows and highlights on the boxes and make it look brilliant"

### What We Built

**Complete Visual Overhaul:**
- Dark theme (#0a0e27 background) with radial gradients
- Modern card-based UI with shadows, hover effects, animations
- Gradient accents (cyan #00d4ff → purple #7c3aed)
- Professional typography (Inter font, proper weights/spacing)
- Chart.js integration for performance trends

**New Advanced Metrics Endpoint (`/api/advanced_metrics`):**

Calculates comprehensive trading & ML statistics:
- **Profit Factor:** 0.783 (total wins / total losses)
- **Sortino Ratio:** -0.162 (downside risk-adjusted)
- **Sharpe Ratio:** -1.032 avg, 914.0 max
- **Max Drawdown:** 1,130.39%
- **Expectancy:** -0.129% per trade
- **Win/Loss Ratio:** 1.23
- **Total PnL:** -2,803.08%
- **Win Rate:** 38.81% (8,452W / 13,290L / 21,776 total)

**Backend Enhancements:**
- Complex SQL for profit factor calculation
- Sortino ratio using downside deviation
- Win/loss ratio from average win vs average loss
- 7-day rolling window for strategy metrics
- Proper handling of CLOSED vs OPEN trades

**Frontend Features:**
- 8-metric advanced trading grid with color coding
- Performance chart with dual Y-axis (score + win rate)
- Ranked strategy cards (#1, #2, etc.) with gradient badges
- Smart model display (filters untrained, shows training status)
- Service monitor with time-since-heartbeat
- 4 key metric overview cards
- Pulse animations on status indicators
- Hover effects on all interactive elements

**Design Specs:**
```css
Colors: Dark (#0a0e27), Accent (cyan/purple gradient)
Typography: Inter font, 700-800 weight headers
Cards: 16px border-radius, 8-16px shadows
Grid: Auto-fit responsive (250-350px min)
Animations: 0.2-0.3s transitions, pulse on status
```

**Technical Implementation:**
- Vanilla JS + Chart.js (no React build pipeline needed)
- Single 31KB HTML file with embedded styles/scripts
- CSS Grid + Flexbox responsive layouts
- Auto-refresh every 10s
- CDN-loaded Chart.js 4.4.0

### Performance Metrics
- **21,776 total trades** in database
- **38.81% win rate** (below 50% threshold)
- **0.783 profit factor** (losing system, needs >1.0)
- **-0.162 Sortino ratio** (negative risk-adjusted returns)
- **1.23 win/loss ratio** (wins are 23% larger than losses)
- **-2,803% total PnL** (cumulative loss across all trades)

### Why These Metrics Matter

1. **Profit Factor < 1.0** = System is losing money overall
2. **Win Rate 38.81%** = Need higher win rate OR better win/loss ratio
3. **Win/Loss Ratio 1.23** = Wins 23% larger, which helps offset low win rate
4. **Sortino -0.162** = Negative returns, downside volatility hurts
5. **Max Drawdown 1,130%** = Extreme risk, needs position sizing fixes

### Files Updated
- `server.py` - Added `/api/advanced_metrics` endpoint (97 lines)
- `blofin-dashboard.html` - Complete rewrite (31KB, modern design)
- `README.md` - Updated with v2.0 features
- `CHANGELOG.md` - Created comprehensive changelog

### Testing Results
```
✅ /health - 200 OK
✅ /api/status - 200 OK
✅ /api/strategies - 200 OK
✅ /api/models - 200 OK
✅ /api/reports - 200 OK
✅ /api/advanced_metrics - 200 OK (NEW)
```

### Key Learnings

1. **Dark themes need careful contrast** - Used #e5e7eb text on #0a0e27 background for readability
2. **Gradients add professionalism** - Linear gradients on badges, radial on background
3. **Chart.js is powerful** - Dual-axis charts, gradient fills, smooth animations
4. **Metrics need context** - Added labels like "↑ Profitable" vs "↓ Losing" for clarity
5. **Vanilla JS is fast** - No build step, instant reload, <100KB total
6. **Color-coding is UX gold** - Green for positive, red for negative, immediate visual feedback

### SQL Queries Learned

**Profit Factor Calculation:**
```sql
SELECT 
    SUM(CASE WHEN pnl_pct > 0 THEN pnl_pct ELSE 0 END) as total_profit,
    ABS(SUM(CASE WHEN pnl_pct < 0 THEN pnl_pct ELSE 0 END)) as total_loss
FROM paper_trades WHERE status = 'CLOSED'
-- profit_factor = total_profit / total_loss
```

**Sortino Ratio (Downside Deviation):**
```sql
SELECT 
    AVG(pnl_pct) as mean_return,
    AVG(CASE WHEN pnl_pct < 0 THEN pnl_pct * pnl_pct ELSE 0 END) as downside_var
FROM paper_trades WHERE status = 'CLOSED'
-- sortino = mean_return / sqrt(downside_var)
```

**Win/Loss Ratio:**
```sql
SELECT 
    AVG(CASE WHEN pnl_pct > 0 THEN pnl_pct ELSE NULL END) as avg_win,
    AVG(CASE WHEN pnl_pct < 0 THEN pnl_pct ELSE NULL END) as avg_loss
FROM paper_trades WHERE status = 'CLOSED'
-- win_loss_ratio = avg_win / abs(avg_loss)
```

### User Feedback
User wanted "fancy, brilliant" dashboard that didn't look like "a 3 year old made it". Delivered:
- Professional dark theme inspired by modern trading platforms
- Advanced metrics (Sortino, profit factor, drawdown) like institutional systems
- Clean, modern aesthetic with gradients and shadows
- Interactive charts for data visualization
- Real-time updates with smooth animations

---

**Session Duration:** ~70 minutes total (08:29-09:00 MST)
**Lines of Code:** ~700 (HTML/CSS/JS + Python)
**Status:** ✅ Complete and operational
**URL:** http://localhost:8888/blofin-dashboard.html
